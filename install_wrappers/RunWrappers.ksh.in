#!/bin/ksh
#PBS -N @BUILD_PACKAGE@
#PBS -j oe
#PBS -l nodes=@NODES@
#PBS -l walltime=@TIME@
#PBS -e @LOG_DIR@/$PBS_JOBID.err
#PBS -o @LOG_DIR@/$PBS_JOBID.out
#PBS -A @PROJ_ID@
source /opt/modules/default/init/ksh
## Set module environment to find spack modules
source @PROJECT_BINARY_DIR@/wrappers/SetModuleEnv.sh

## load caffe
module load caffe-1.0-gcc-4.9.3-kzfrcfk
rm -f ./load_modules.sh
python @PROJECT_BINARY_DIR@/wrappers/LoadSpackModules.py
source ./load_modules.sh
rm -f ./load_modules.sh

export LD_LIBRARY_PATH=@PROJECT_BINARY_DIR@/libcuda_detect:$LD_LIBRARY_PATH
export DYNINSTAPI_RT_LIB=@PROJECT_BINARY_DIR@/3rdparty/spack/opt/spack/cray-CNL-interlagos/gcc-4.9.3/dyninst-9.3.2-uit3bhiupk26ssoev4a6dvs7dlq7ghmk/lib/libdyninstAPI_RT.so
## Load boost from external location (may not be necessary on machines that are not titan...)

## Launch Caffe
cd @DATA_DIRECTORY@

#aprun -b -n 1 -N 1 nvprof caffe train --solver=@DATA_DIRECTORY@/lenet_solver.prototxt
aprun -n 1 -N 1 caffe train --solver=@DATA_DIRECTORY@/lenet_solver.prototxt
